<!DOCTYPE html>
<html>
<head>
  <title>Make a Payment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
      background-color: #f5f5f5;
    }
    #container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Make a Payment</h1>
  <p>Click the button below to pay with Google Pay.</p>
  <div id="container"></div>

  <!-- Load jQuery Library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <!-- Load Google Pay API -->
  <script src="https://pay.google.com/gp/p/js/pay.js" async onload="onGooglePayLoaded()"></script>

  <script>
    // Global key for canMakePayment cache.
    const canMakePaymentCache = 'canMakePaymentCache';
    
    /**
     * Check whether can make payment with Google Pay or not. It will check session storage
     * cache first and use the cache directly if it exists. Otherwise, it will call
     * canMakePayment method from PaymentRequest object and return the result, the
     * result will also be stored in the session storage cache for future usage.
     *
     * @private
     * @param {PaymentRequest} request The payment request object.
     * @return {Promise} a promise containing the result of whether can make payment.
     */
    function checkCanMakePayment(request) {
      // Check canMakePayment cache, use cache result directly if it exists.
      if (sessionStorage.hasOwnProperty(canMakePaymentCache)) {
        return Promise.resolve(JSON.parse(sessionStorage[canMakePaymentCache]));
      }

      // If canMakePayment() isn't available, default to assume the method is
      // supported.
      var canMakePaymentPromise = Promise.resolve(true);

      // Feature detect canMakePayment().
      if (request.canMakePayment) {
        canMakePaymentPromise = request.canMakePayment();
      }

      return canMakePaymentPromise
          .then((result) => {
            // Store the result in cache for future usage.
            sessionStorage[canMakePaymentCache] = result;
            return result;
          })
          .catch((err) => {
            console.log('Error calling canMakePayment: ' + err);
            return false; // Return false if there's an error
          });
    }

    /** Launches payment request flow when user taps on buy button. */
    function onBuyClicked() {
      if (!window.PaymentRequest) {
        console.log('Web payments are not supported in this browser.');
        return;
      }

      // Create supported payment method.
      const supportedInstruments = [
        {
          supportedMethods: 'https://tez.google.com/pay',
          data: {
            pa: '9469050879@ptsbi', // Ensure this is a valid merchant UPI ID
            pn: 'HSS Shangus',       // Payee name
            tr: '1234ABCD',          // Your custom transaction reference ID
            url: 'https://yourwebsite.com/order', // Replace with your actual order URL
            mc: '5045',               // Merchant category code
            tn: 'Admission Fee',      // Transaction note
          },
        }
      ];

      // Create order detail data.
      const details = {
        total: {
          label: 'Total',
          amount: {
            currency: 'INR',
            value: '10.01', // sample amount
          },
        },
        displayItems: [{
          label: 'Original Amount',
          amount: {
            currency: 'INR',
            value: '10.01',
          },
        }],
      };

      // Create payment request object.
      let request = null;
      try {
        request = new PaymentRequest(supportedInstruments, details);
      } catch (e) {
        console.log('Payment Request Error: ' + e.message);
        return;
      }
      if (!request) {
        console.log('Web payments are not supported in this browser.');
        return;
      }

      var canMakePaymentPromise = checkCanMakePayment(request);
      canMakePaymentPromise
          .then((result) => {
            showPaymentUI(request, result);
          })
          .catch((err) => {
            console.log('Error calling checkCanMakePayment: ' + err);
          });
    }

    /**
    * Show the payment request UI.
    *
    * @private
    * @param {PaymentRequest} request The payment request object.
    * @param {boolean} canMakePayment The result of canMakePayment check.
    */
    function showPaymentUI(request, canMakePayment) {
      if (!canMakePayment) {
        handleNotReadyToPay();
        return;
      }

      // Set payment timeout.
      let paymentTimeout = window.setTimeout(function() {
        window.clearTimeout(paymentTimeout);
        request.abort()
            .then(function() {
              console.log('Payment timed out after 20 minutes.');
            })
            .catch(function() {
              console.log('Unable to abort, user is in the process of paying.');
            });
      }, 20 * 60 * 1000); /* 20 minutes */

      request.show()
          .then(function(instrument) {
            window.clearTimeout(paymentTimeout);
            processResponse(instrument); // Handle response from browser.
          })
          .catch(function(err) {
            console.log('Payment request error: ', err);
          });
    }

    /** Handle Google Pay not ready to pay case. */
    function handleNotReadyToPay() {
      alert('Google Pay is not ready to pay. Please ensure Google Pay is set up correctly.');
    }

    function paymentResponseToJsonString(paymentResponse) {
      // PaymentResponse is an interface, JSON.stringify works only on dictionaries.
      var paymentResponseDictionary = {
        methodName: paymentResponse.methodName,
        details: paymentResponse.details,
        payerName: 'Sheikh Gulfam',
        payerPhone: '9682547458',
        payerEmail: 'sheikhgulfam85@gmail.com',
      };
      return JSON.stringify(paymentResponseDictionary, undefined, 2);
    }      

    /**
    * Process the response from browser.
    *
    * @private
    * @param {PaymentResponse} instrument The payment instrument that was authed.
    */
    function processResponse(instrument) {
      var instrumentString = paymentResponseToJsonString(instrument);
      console.log('Instrument String:', instrumentString);

      $.ajax({
          type: 'POST',
          url: 'buy.php',
          data: { trackDetails: instrumentString },
          success: function(response){
              console.log('SUCCESS BLOCK');
              console.log(response);
              completePayment(instrument, 'success', 'Payment succeeded.');
          },
          error: function(response) {
              console.log('ERROR BLOCK');
              console.log(response);
              completePayment(instrument, 'fail', 'Payment failed.');
          }
       });
    }

    /**
    * Notify browser that the instrument authorization has completed.
    *
    * @private
    * @param {PaymentResponse} instrument The payment instrument that was authed.
    * @param {string} result Whether the auth was successful. Should be either
    * 'success' or 'fail'.
    * @param {string} msg The message to log in console.
    */
    function completePayment(instrument, result, msg) {
      instrument.complete(result)
          .then(function() {
            console.log('Payment complete: ' + msg);
          })
          .catch(function(err) {
            console.log('Error completing payment: ', err);
          });
    }
  </script>

  <div class="col-xs-12">
    <button class="btn btn-info pull-right" onclick="onBuyClicked()">Payment Now</button>
  </div>
</body>
</html>
